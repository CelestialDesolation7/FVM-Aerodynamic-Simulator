# 气动热仿真项目物理原理

## 1. 项目概述

### 1.1 仿真场景

本项目模拟的是**二维气流绕障碍物流动**的物理现象。具体场景为：

- 空气从计算域左侧以水平流入
- 计算域中央放置一个障碍物（圆形、星形、菱形等）
- 气流撞击障碍物后产生**激波**（shock wave）
- 激波后方的气体被压缩和加热，温度显著升高
- 障碍物后方形成**尾流**区域

### 1.2 物理现象

当超音速气流撞击障碍物时，会产生以下关键物理现象：

1. **弓形激波（Bow Shock）**：在物体前方形成弧形激波，气体穿过激波时被急剧压缩和加热
2. **驻点加热**：物体正前方（驻点）温度最高，因为气体在此处几乎停滞，动能完全转化为热能
3. **压力分布**：物体前方压力最高，向两侧和后方逐渐降低
4. **尾流**：物体后方形成低压、低密度的尾流区域，一道红色长线

**启用粘性模拟后的额外现象**：

5. **边界层**：在物体表面附近形成速度梯度较大的薄层，流体从壁面的零速度过渡到主流速度
6. **壁面热流**：热量通过热传导从高温流体传递到壁面，可计算气动加热
7. **粘性耗散**：流体内部的摩擦将动能转化为热能，尤其在边界层内显著

---

## 2. 物理量定义

### 2.1 基本物理量整理

核心物理量：

| 符号   | 名称       | 单位   | 物理含义                            |
| ------ | ---------- | ------ | ----------------------------------- |
| $\rho$ | 密度       | kg/m³  | 单位体积内气体的质量                |
| $u$    | x方向速度  | m/s    | 气体沿水平方向的运动速度            |
| $v$    | y方向速度  | m/s    | 气体沿垂直方向的运动速度            |
| $p$    | 压强       | Pa     | 单位面积上气体施加的力              |
| $T$    | 温度       | K      | 气体的热力学温度                    |
| $E$    | 总能量密度 | J/m³   | 单位体积内气体的总能量（内能+动能） |
| $e$    | 比内能     | J/kg   | 单位质量气体的内能                  |
| $c$    | 声速       | m/s    | 声波在气体中传播的速度              |
| $Ma$   | 马赫数     | 无量纲 | 流速与声速之比                      |

**粘性流动相关物理量**（启用粘性模拟时）：

| 符号        | 名称         | 单位    | 物理含义                                  |
| ----------- | ------------ | ------- | ----------------------------------------- |
| $\mu$       | 动力粘性系数 | Pa·s    | 流体抵抗剪切变形的能力                    |
| $\nu$       | 运动粘性系数 | m²/s    | $\nu = \mu/\rho$，动量扩散系数            |
| $k$         | 热导率       | W/(m·K) | 热量传导的能力                            |
| $\tau_{ij}$ | 粘性应力张量 | Pa      | 流体内部由于速度梯度产生的应力            |
| $q_x, q_y$  | 热通量       | W/m²    | 单位面积单位时间传递的热量                |
| $Re$        | 雷诺数       | 无量纲  | $Re = \rho u L / \mu$，惯性力与粘性力之比 |
| $Pr$        | 普朗特数     | 无量纲  | $Pr = \mu C_p / k$，动量扩散与热扩散之比  |

### 2.2 物理常数

代码中定义的物理常数（位于`common.h`）：

```cpp
constexpr float GAMMA = 1.4f;    // 比热比（空气）
constexpr float R_GAS = 287.05f; // 空气的比气体常数 [J/(kg·K)]
constexpr float CV = R_GAS / (GAMMA - 1.0f);  // 定容比热
constexpr float CP = GAMMA * CV;              // 定压比热

// Sutherland公式常数（用于计算粘性系数）
constexpr float MU_REF = 1.716e-5f;    // 参考粘性系数 [Pa·s]
constexpr float T_REF = 273.15f;       // 参考温度 [K]
constexpr float S_SUTHERLAND = 110.4f; // Sutherland常数 [K]

// 普朗特数
constexpr float PR = 0.72f;  // 空气的普朗特数
```

**物理解释**：

- **比热比 γ（GAMMA）**：定压比热与定容比热之比，对于双原子气体（如空气）约为1.4。
- **比气体常数 R**：与气体分子量相关，空气约为287 J/(kg·K)。
- **定容比热 $C_v$**：保持体积不变时，使单位质量气体升温1K所需的热量。
- **定压比热 $C_p$**：保持压力不变时，使单位质量气体升温1K所需的热量。
- **Sutherland常数**：用于计算温度相关的粘性系数。
- **普朗特数 Pr**：动量扩散率与热扩散率之比，对于空气约为0.72。

### 2.3 守恒变量与原始变量

在此CFD中，我们区分两种变量形式：

**守恒变量（Conservative Variables）**：直接参与守恒方程的变量

$$
\mathbf{U} = \begin{pmatrix} \rho \\ \rho u \\ \rho v \\ E \end{pmatrix}
$$

- $\rho$：质量密度
- $\rho u$：x方向动量密度
- $\rho v$：y方向动量密度
- $E$：总能量密度

**原始变量（Primitive Variables）**：更直观的物理量

$$
\mathbf{W} = \begin{pmatrix} \rho \\ u \\ v \\ p \end{pmatrix}
$$

守恒方程本质上描述的是质量、动量、能量的守恒。
使用守恒形式的变量可以确保数值计算过程中这些物理量在全局范围内守恒。

### 2.4 能量的定义

**总能量密度 E**：

$$
E = \rho e + \frac{1}{2}\rho(u^2 + v^2)
$$

其中：

- $\rho e$ 是内能密度（与温度相关的热能）
- $\frac{1}{2}\rho(u^2 + v^2)$ 是动能密度

**内能与温度、压强的关系**（对于理想气体）：

$$
e = C_v T = \frac{p}{(\gamma-1)\rho}
$$

因此：

$$
\rho e = \frac{p}{\gamma - 1}
$$

---

## 3. 基本物理原理

注意：本项目涉及且仅涉及到以下方程。

每个条目的第一条都是原始方程，下面的都是在解释。

### 3.1 欧拉方程组（主控制方程）

**二维无粘可压缩欧拉方程**是Navier-Stokes方程在忽略粘性的简化形式，适用于高速流动中粘性效应相对较小的情况。

**守恒形式的欧拉方程**：

$$
\frac{\partial \mathbf{U}}{\partial t} + \frac{\partial \mathbf{F}}{\partial x} + \frac{\partial \mathbf{G}}{\partial y} = 0
$$

其中 $\mathbf{U}$ 是守恒变量向量，$\mathbf{F}$ 和 $\mathbf{G}$ 分别是x方向和y方向的通量向量。

**展开形式**：

**质量守恒方程**：

$$
\frac{\partial \rho}{\partial t} + \frac{\partial (\rho u)}{\partial x} + \frac{\partial (\rho v)}{\partial y} = 0
$$

某区域内质量的变化率等于流入和流出该区域的质量之差。

**x方向动量守恒方程**：

$$
\frac{\partial (\rho u)}{\partial t} + \frac{\partial (\rho u^2 + p)}{\partial x} + \frac{\partial (\rho u v)}{\partial y} = 0
$$

动量的变化由动量的输运（流体携带动量进出）和压力做功共同决定。

**y方向动量守恒方程**：

$$
\frac{\partial (\rho v)}{\partial t} + \frac{\partial (\rho u v)}{\partial x} + \frac{\partial (\rho v^2 + p)}{\partial y} = 0
$$

**能量守恒方程**：

$$
\frac{\partial E}{\partial t} + \frac{\partial [(E + p)u]}{\partial x} + \frac{\partial [(E + p)v]}{\partial y} = 0
$$

能量的变化由能量的输运和压力做功共同决定。$(E+p)u$ 表示流体在流动时不仅携带能量E，还需要克服压力做功。

---

### 3.2 Navier-Stokes方程（主控制方程）

当启用粘性模拟时，控制方程从欧拉方程扩展为**可压缩Navier-Stokes方程**：

$$
\frac{\partial \mathbf{U}}{\partial t} + \nabla \cdot \mathbf{F}_{conv} = \nabla \cdot \mathbf{F}_{visc}
$$

其中 $\mathbf{F}_{conv}$ 是对流通量（与欧拉方程相同），$\mathbf{F}_{visc}$ 是粘性通量。

**展开形式**：

由于粘性效应的引入，动量方程和能量方程的右端增加了粘性项：

**质量守恒方程**（与欧拉方程相同）：

$$
\frac{\partial \rho}{\partial t} + \frac{\partial (\rho u)}{\partial x} + \frac{\partial (\rho v)}{\partial y} = 0
$$

**x方向动量守恒方程**：

$$
\frac{\partial (\rho u)}{\partial t} + \frac{\partial (\rho u^2 + p)}{\partial x} + \frac{\partial (\rho u v)}{\partial y} = \frac{\partial \tau_{xx}}{\partial x} + \frac{\partial \tau_{xy}}{\partial y}
$$

流体微团动量的变化不仅受压力和对流影响，还受到内部粘性摩擦力（应力张量的散度）的作用。右端项代表了粘性力在x方向上的合力。

**y方向动量守恒方程**：

$$
\frac{\partial (\rho v)}{\partial t} + \frac{\partial (\rho u v)}{\partial x} + \frac{\partial (\rho v^2 + p)}{\partial y} = \frac{\partial \tau_{xy}}{\partial x} + \frac{\partial \tau_{yy}}{\partial y}
$$

**能量守恒方程**：

$$
\frac{\partial E}{\partial t} + \frac{\partial [(E + p)u]}{\partial x} + \frac{\partial [(E + p)v]}{\partial y} = \frac{\partial}{\partial x}(u\tau_{xx} + v\tau_{xy} - q_x) + \frac{\partial}{\partial y}(u\tau_{xy} + v\tau_{yy} - q_y)
$$

其中：

总能量的变化增加了两部分来源：

1. **粘性做功**（$u\tau_{xx} + v\tau_{xy}$ 等）：粘性力对流体做功，将机械能转化为内能（摩擦生热）。
2. **热传导**（$-q_x, -q_y$）：热量因温度差异而流入或流出的贡献（$q$是热流密度，$-\nabla \cdot \mathbf{q}$ 为热量净流入）。

粘性应力张量描述了由于速度梯度引起的内部摩擦力：

$$
\tau_{xx} = \mu \left( 2\frac{\partial u}{\partial x} - \frac{2}{3}\nabla \cdot \mathbf{v} \right)
$$

$$
\tau_{yy} = \mu \left( 2\frac{\partial v}{\partial y} - \frac{2}{3}\nabla \cdot \mathbf{v} \right)
$$

$$
\tau_{xy} = \mu \left( \frac{\partial u}{\partial y} + \frac{\partial v}{\partial x} \right)
$$

其中 $\nabla \cdot \mathbf{v} = \frac{\partial u}{\partial x} + \frac{\partial v}{\partial y}$ 是速度散度。

详细解释见[知乎的这篇文章](https://zhuanlan.zhihu.com/p/381804810)。

**自然语言解释**：

- $\tau_{xx}$ 和 $\tau_{yy}$ 是正应力，描述了流体在各方向上被拉伸或压缩时产生的阻力
- $\tau_{xy}$ 是剪切应力，描述了相邻流体层之间由于速度差异而产生的摩擦力
- $-\frac{2}{3}\nabla \cdot \mathbf{v}$ 项是Stokes假设（体积粘性为零）的结果

---

### 3.3 Sutherland粘性公式

空气的粘性系数随温度变化，使用**Sutherland公式**计算：

$$
\mu = \mu_{ref} \left( \frac{T}{T_{ref}} \right)^{3/2} \frac{T_{ref} + S}{T + S}
$$

其中：

- $\mu_{ref} = 1.716 \times 10^{-5}$ Pa·s（参考粘性系数）
- $T_{ref} = 273.15$ K（参考温度）
- $S = 110.4$ K（Sutherland常数）

温度越高，分子运动越剧烈，粘性系数越大。Sutherland公式是基于气体分子动力学理论的**经验公式**。

热导率通过普朗特数计算：

$$
k = \frac{\mu C_p}{Pr}
$$

---

### 3.4 粘性通量

x方向粘性通量：

$$
\mathbf{F}_{visc,x} = \begin{pmatrix} 0 \\ \tau_{xx} \\ \tau_{xy} \\ u\tau_{xx} + v\tau_{xy} - q_x \end{pmatrix}
$$

y方向粘性通量：

$$
\mathbf{F}_{visc,y} = \begin{pmatrix} 0 \\ \tau_{xy} \\ \tau_{yy} \\ u\tau_{xy} + v\tau_{yy} - q_y \end{pmatrix}
$$

**物理意义**：

- 质量方程无粘性项（粘性不产生质量）
- 动量方程的粘性项是应力张量的散度
- 能量方程包含粘性做功（$u\tau_{xx} + v\tau_{xy}$等）和热传导（$-q_x, -q_y$）

---

### 3.5 理想气体状态方程

理想气体状态方程将压强、密度和温度联系起来：

$$
p = \rho R T
$$

气体的压强与密度和温度成正比。温度越高或密度越大，气体分子运动越剧烈或碰撞越频繁，压强就越大。

由此可以推导温度：

$$
T = \frac{p}{\rho R}
$$

---

### 3.6 声速公式

**声速**是压力波（如声波）在介质中传播的速度：

$$
c = \sqrt{\gamma \frac{p}{\rho}} = \sqrt{\gamma R T}
$$

**物理意义**：声速反映了气体的"弹性"程度。温度越高，分子运动越快，压力扰动传播也越快。

**马赫数**定义为流速与当地声速之比：

$$
Ma = \frac{|\mathbf{v}|}{c} = \frac{\sqrt{u^2+v^2}}{c}
$$

- $Ma < 1$：亚音速流动
- $Ma = 1$：音速流动
- $Ma > 1$：超音速流动

---

### 3.7 Fourier热传导定律

$$
q_x = -k \frac{\partial T}{\partial x}
$$

- $$k$$ ：热导率。
- $$\frac{\partial T}{\partial x}$$：**温度梯度**。它描述了温度随空间变化的快慢。
- **负号：** 代表热量总是从高温流向低温（逆着梯度方向）。

---

## 4. 场景建模

### 4.1 有限体积法

本项目采用**有限体积法（Finite Volume Method, FVM）**进行空间离散化。

将计算域划分为有限个控制体（网格单元），在每个控制体上对守恒方程进行积分。

对于上文描述的守恒方程：

$$
\frac{\partial \mathbf{U}}{\partial t} + \nabla \cdot \mathbf{F} = 0
$$

在单元 $(i,j)$ 上积分后得到：

$$
\frac{d\mathbf{U}_{i,j}}{dt} = -\frac{1}{\Delta x}(F_{i+1/2,j} - F_{i-1/2,j}) - \frac{1}{\Delta y}(G_{i,j+1/2} - G_{i,j-1/2})
$$

可以这样理解，单元内**守恒变量的变化率**（$$\frac{\partial \mathbf{U}}{\partial t}$$）等于通过该单元各边界面的净通量（也就是散度，$$\nabla \cdot \mathbf{F}$$)。
例如计算一个房间内空气量的变化——等于从各扇门窗进出的空气量之差。

### 4.2 黎曼求解器

在有限体积法中，计算单元界面上的通量是关键问题。由于相邻单元的状态可能不同，界面处实际上是一个**黎曼问题**。
黎曼问题，也就是一个，初始状态存在间断的，守恒律方程初值问题。

****

为了理解为什么引入，我们设想一个场景：

- 某两个单元格之间的一个竖着的界面，显然有一个通量，我们这里就假设是质量通量，即多少空气流入流出。
- 显然为了知道这个值，我们需要看看左右两个单元格内，空气的水平移动速度，这里假设两个格子空气的其他条件一样。
- 于是我们可以知道，左右两个单元格中，分别打算通过这个界面传过多少通量（在这里就是动量通量）。
- 我们知道了两边试图传递的动量通量，怎么获得这个界面的动量通量？相加吗？
- 相加会得到错误结果，导致整个仿真区域迅速被平均化，显示出一种颜色。
- 为什么？
- 因为空气可压缩。
- 根据守恒方程的波动理论，守恒方程可以视为描述了状态信息的传递。
- 警告：对于任何一种通量（通量的变化是一种信息），其传播速度都无法超过音速。
- 如果左边很快（输入1000m/s的大量空气），右边静滞
	那么左右不会立刻像刚体碰撞一样改变速度（即左右都变成以500m/s的速度向右走）
	而是会出现，左边将右边压缩，右边被推走。
	这种情况称为激波。
- 我们需要知道一个基本事实：
     左右两边相撞引起的压强，动量交换等状态变化，最大只能以音速传递。
     （这个结论由波动理论给出）
- 此时，由于相撞的接触面本身超音速向右运动，而向左传递的状态变化，只能以音速向左，速度叠加会导致状态无法立即向左边传递。
- 这时，显然通量应该仅仅由左侧格子决定。右侧格子此时好像不存在。
- 对于更复杂的情况（即状态传递可以同时向左或向右，而不是被气体运动速度一边倒地拉向一侧），则需要进入Case3：
- 二者的碰撞，在物理上会产生3个波，分别是向左和向右的状态波，以及中间的一道分界波（严格来说叫”熵波“）。
- （这三个波的存在均由波动理论给出）
- 于是我们需要临时将这个界面分为五个部分：

     ```
     左侧格子界面 - 向左冲击波 - 中间分界波 - 向右冲击波 - 右侧格子界面
     ```

- 我们要的通量就是中间分界波“附近”的物理状态。

- 如果中间分界波正在向右运动（对应条件判断，速度大于0），则分界面理论上处于左侧物质里，在左侧区域线性插值。

- 如果中间分界波正在向左运动（对应条件判断，速度大于0），则分界面理论上处于右侧物质里，在右侧区域线性插值。

- 通过黎曼求解器，可以用解析公式简单获得中间分界波的状态计算结果。

#### 4.2.1 波动理论基础

在我们讨论的这个微小的网格界面（以X轴方向为例）上，有三类速度在起作用：

1. **$u$ (流体速度)**：气体分子跑得有多快。规定向右为正（$u > 0$）。
2. **$c$ (声速)**：声音在气体里传播的固有速度。永远是正数（$c > 0$）。
3. **$\lambda$ (特征波速)**：这是**信息**相对于**我们（不动的观察者）**传播的速度。

对于流体中任何一点（我们这里只讨论一个方向上），通过波动理论，可以证明，其存在三个特征波速，物理状态的变化会在这三个速度上传播：

- **$\lambda_1 = u - c$**：试图逆流而上的声波（左行声波）。

- **$\lambda_2 = u$**：熵波/剪切波（随波逐流）。

- **$\lambda_3 = u + c$**：顺流而下的声波（右行声波）。

**波的类型**：

- **激波（Shock）**：压力突变，**压缩**流体。因为气体的超高速压缩产生。
- **稀疏波（Rarefaction）**：压力渐变，**膨胀**流体。因为气体的离开产生。
- **熵波（Entropy）**：气体分界面。这个界面处达成了暂时的受力平衡，但是左右两侧流体的热力学状态不同。
- **剪切波（Shear）**：气体分界面。这个界面处达成了暂时的受力平衡，但是左右两侧流体的Y轴方向速度状态不同。

**关键事实：**

- 我们只能确定的说，熵波或剪切波对应于 $\lambda_2$。
- 但是，剩下两个特征速度，和剩下两种波的类型，不存在确定映射关系。
- 稀疏波和激波都可以分别以这两种速度传播。

#### 4.2.2 Rankine-Hugoniot 关系（守恒量关系）

在流体力学中，如果存在一个以速度 $S$ 移动的**激波**，隔开了左状态 $U_L$ 和右状态 $U_R$，那么物理守恒律（Rankine-Hugoniot 条件）强制规定：

$$
F(U_R) - F(U_L) = S \cdot (U_R - U_L)
$$

- **左边**：通量的跳跃量。
- **右边**：激波速度 $S$ 乘以 状态的跳跃量。
- **几何意义**：这描述了一个以速度 $S$ 扫描过的矩形区域内的守恒量变化。

- **关键**：这个定义精确地描述了，激波处流体状态要满足的条件。
	也就是至少要保证守恒，就算不连续。
	
- **假设**：整个波内部波速是一样的。都是 $S$ 。

#### 4.2.3 Roe平均速度（用于计算激波速度）

黎曼问题本质上是解这个方程（Rankine-Hugoniot 跳跃条件）：

$$
F(U_R) - F(U_L) = S \cdot (U_R - U_L)
$$

这里 $F(U)$ 是非线性的（比如包含 $u^2$）。直接解很难。

在微积分里，对于任意函数 $f(x)$，总存在一个中间点 $\tilde{x}$，使得：

$$
f(b) - f(a) = f'(\tilde{x}) \cdot (b - a)
$$

对于流体力学方程组，能不能找到一个**平均状态 $\tilde{U}$（包含 $\tilde{\rho}, \tilde{u}, \tilde{H}$）**，使得下面的式子**精确成立**？

$$
F(U_R) - F(U_L) = \mathbf{A}(\tilde{U}) \cdot (U_R - U_L)
$$

其中 $\mathbf{A}$ 是雅可比矩阵（物理含义是波速矩阵）。

如果能找到这个 $\tilde{U}$，那么 $\mathbf{A}(\tilde{U})$ 的特征值（也就是 $\tilde{u} \pm \tilde{c}$），就是**连接左右状态的精确激波速度**。

Roe 构造了一种特殊的平均状态 $\tilde{U}$。基于这个状态算出来的特征值（$\tilde{u} \pm \tilde{c}$），**恰好等于**激波的精确传播速度（在完全激波的情况下）。

这个状态就是：

$$
\text{速度 }\tilde{u} = \frac{\sqrt{\rho_L} u_L + \sqrt{\rho_R} u_R}{\sqrt{\rho_L} + \sqrt{\rho_R}} \\
\text{热焓（也可以叫做总能量）}\tilde{H} = \frac{\sqrt{\rho_L} H_L + \sqrt{\rho_R} H_R}{\sqrt{\rho_L} + \sqrt{\rho_R}}
$$

那么，$\mathbf{A}(\tilde{U})$ 就完美满足了跳跃条件。在此基础下，计算出的特征速度，可以代表分界面上波传递的特征速度。
激波处流体运动速度直接代入上面的结果就可以获得。
激波处音速通过用热焓减去动能，获得内能，利用理想气体状态方程求温度，再输入音速公式即可。

#### 4.2.4 两个边界处的波速

由于我们已知两个格子边界处的物理状态，我们显然可以得出两个波速：

- $v_L - c_L$：左侧格子试图向左传播的波，对应波速。
- $v_R + c_R$：右侧格子试图向右传播的波，对应波速。

关键：这是 **特征速度（声速）**。它精确对应 **稀疏波的头部速度**。

这是因为两个格子的边界，是我们的假设下，绝对还没有受到两个界面输出的流体在中间相互作用传出的波影响的两个边界。让我们看稀疏波的物理图景。稀疏波是一个**扇形（Fan）**，它把原本连接在一起的状态“撕”开了。

- **头部（Head）**：这是稀疏波的最前沿，它刚刚接触到**尚未被扰动的区域**（即边界状态 $U_B$）。
- **尾部（Tail）**：这是稀疏波的最后沿，它连接着中间的状态，即星区 $U^*$。

#### 4.2.5 Davis分类

我们在计算之前，**不知道**这两个状态之间到底是激波还是稀疏波，我们只能都算一下，然后来分类讨论（这里以左边界为例）：

##### 情况 A：如果是激波

- **物理事实**：激波是超音速的。激波速度 $S_{shock}$ 会比波前的声速 $v_B - c_B$ **跑得更快**（对于左行波，意味着更负）。
- **Roe 速度**：精确等于 $S_{shock}$。
- **格子边界特征速度**：$v_B - c_B$ （绝对值比激波小）。
- **代码逻辑**：`fminf(声速, 激波速度)` $\rightarrow$ 取了 **激波速度**（更负的那一个）。
	我们抓住了最快的激波边界。

##### 情况 B：如果是稀疏波

- **物理事实**：稀疏波是扩散的。
	- 最外面的（头部）跑得最快，速度是 $v_B - c_B$。
	- Roe 平均速度算出来的是某种“中间平均速度”，它一定落在稀疏波扇形的**内部**（比头部慢，比尾部快）。
- **代码逻辑**：`fminf(头部声速, 中间Roe速度)` $\rightarrow$ 取了 **头部声速**（更负的那一个，因为它在最外沿）。
	我们抓住了稀疏波的最外沿边界。

其他方向同理。

#### 4.2.6 HLL求解器

**HLL（Harten-Lax-van Leer）求解器**是一种近似黎曼求解器，假设波系中只有两个波（最左和最右的波）。

波速估计：

$$
S_L = \min(u_L - c_L, u_R - c_R)
$$

$$
S_R = \max(u_L + c_L, u_R + c_R)
$$

其中下标L和R分别表示界面左右两侧的状态。

HLL通量公式：

- 若 $S_L \geq 0$（所有波都向右传播）：$\mathbf{F}_{1/2} = \mathbf{F}_L$
- 若 $S_R \leq 0$（所有波都向左传播）：$\mathbf{F}_{1/2} = \mathbf{F}_R$
- 否则（界面处于两波之间）：

$$
\mathbf{F}_{1/2} = \frac{S_R \mathbf{F}_L - S_L \mathbf{F}_R + S_L S_R (\mathbf{U}_R - \mathbf{U}_L)}{S_R - S_L}
$$

#### 4.2.7 HLLC求解器

**HLLC求解器**是HLL的改进版本，在两个声波之间额外考虑一个**接触间断波**（Contact Discontinuity），波速为 $S^*$。

HLLC 模型最关键的假设是：**接触间断两侧的压力和法向速度是连续的。**

这意味着，在星区内，流体的法向速度 $v^*_K$ **必须等于** 中间接触波的移动速度 $S^*$。如果流体速度不等于接触间断速度，流体就会穿过这个“接触面”，那它就不叫接触间断了。

接触间断波速度计算：

$$
S^* = \frac{p_R - p_L + \rho_L u_L (S_L - u_L) - \rho_R u_R (S_R - u_R)}{\rho_L (S_L - u_L) - \rho_R (S_R - u_R)}
$$

HLLC能更准确地处理接触间断（如密度突变但压力相同的情况），这在多物质流动或具有温度不连续的情况下特别重要。

我们仍然要使用Rankine-Hugoniot守恒量关系求我们的通量。

以X轴方向，左星区为例：

$$
F^*_K = F_K + S_K (U^*_K - U_K)
$$

其中：

- $F^*_K$：是我们要求的 **星区通量**。
- $F_K$：是 **左侧原始状态通量**。（已知）
- $S_K$：是 **左波速**。（已知）
- $U^*_K$：是 **星区状态**。（已知）
- $U_K$：是 **左侧原始状态**。（已知）

星区状态 $U^*_K$ 与原始状态 $U_K$ 之间通过波速 $S_K$ 连接。

定义一个 **密度缩放因子** (代码中的 `coeff`)：

$$
\Omega_K = \frac{S_K - v_K}{S_K - S^*}
$$

- 物理含义：这是由质量守恒导出的压缩/膨胀比率。
- $v_K$：格子边界上的速度。

基于此，中间状态向量 $U^*_K$ 的各个分量为：

$$
U^*_K = \Omega_K \cdot \begin{pmatrix} \rho_K \\ (\rho u)_K^* \\ (\rho v)_K^* \\ E_K^* \end{pmatrix} = \begin{pmatrix}  \rho_K \Omega_K \\  \rho_K \Omega_K u_K \\  \rho_K \Omega_K S^* \\  \rho_K \Omega_K \left( \frac{E_K}{\rho_K} + (S^* - v_K)\left[ S^* + \frac{p_K}{\rho_K(S_K - v_K)} \right] \right) \end{pmatrix}
$$

1. **密度 ($\rho^{*}_K$)**：
	$$
	\rho^*_K = \rho_K \frac{S_K - v_K}{S_K - S^*}
	$$
	
2. **切向动量 ($\rho u$ - X方向)**：

	HLLC 假设切向速度穿过激波/声波时保持不变（剪切波只在 $S^*$ 处跳变）：

	$$
	(\rho u)^*_K = \rho^*_K u_K
	$$

3. **法向动量 ($\rho v$ - Y方向)**：

	在星区内，法向速度处处相等，均等于接触间断速度：

	$$
	(\rho v)^*_K = \rho^*_K S^*
	$$

4. **总能量 ($E^{*}_K$)**：

	推导后的动量/能量守恒组合形式：

	$$
	E^*_K = \frac{E_K(S_K - v_K) + p^* S^* - p_K v_K}{S_K - S^*}
	$$

	其中中间压力 $p^*$ 计算为：

	$$
	p^* = p_K + \rho_K (S_K - v_K)(S^* - v_K)
	$$



这是最后一步，利用 **Rankine-Hugoniot 关系** 直接求通量，避免重复代入欧拉方程。

$$
F^*_K = F_K + S_K (U^*_K - U_K)
$$

写成分量形式（Y 方向通量）：

$$
\begin{pmatrix} g_{\rho} \\ g_{\rho u} \\ g_{\rho v} \\ g_{E} \end{pmatrix}^* =  \begin{pmatrix} (\rho v)_K \\ (\rho u v)_K \\ (\rho v^2 + p)_K \\ v_K(E_K + p_K) \end{pmatrix}  + S_K  \left[  \begin{pmatrix} \rho^* \\ (\rho u)^* \\ (\rho v)^* \\ E^* \end{pmatrix}_K  -  \begin{pmatrix} \rho \\ \rho u \\ \rho v \\ E \end{pmatrix}_K  \right]
$$

#### 4.2.9 跨音速点处理

两个求解器会遭遇的一种特殊情况：
如果某一侧波速非常接近 0 ，但又比 0 大一点点，代码会进入前两个”所有波都向一个方向传播“的分支。

这种情况下得出的结果不如星区的结果可靠，于是设定一个阈值，强制在某一侧波速足够小的时候，使得其至少等于该阈值，而不是刚刚好无法进入星区。

### 4.3 MUSCL重构

为了获得更高的空间精度，本项目使用**MUSCL（Monotone Upstream-centered Schemes for Conservation Laws）**重构方法，将精度从一阶提升到二阶。

**基本思想**：不是将单元内的变量视为常数，而是假设变量在单元内线性变化，通过斜率限制器控制斜率以避免在间断处产生伪振荡。

其实就是线性插值，没什么好说的。

只是插值要避免一种特殊情况：中间值位于“波谷”或“波峰”，这个时候放弃插值，只能用低精度。

这种特殊情况通过$$ minmod(a,b) $$限制器实现；

$$
\text{minmod}(a, b) = \begin{cases}
\text{sign}(a) \cdot \min(|a|, |b|) & \text{if } ab > 0 \\
0 & \text{if } ab \leq 0
\end{cases}
$$

Minmod限制器的作用是"保守地估计斜率"。如果左右两侧的差分符号相反（说明这里可能是极值点），就将斜率设为0（这意味着我们放弃了使用斜率试图获得二阶精度）；
否则取较小的斜率，这样可以防止在激波处产生数值振荡。

**重构过程**（以x方向为例）：

界面左侧状态（从单元i外推到i+1/2）：

$$
q_L = q_i + \frac{1}{2}\sigma_i
$$

界面右侧状态（从单元i+1内推到i+1/2）：

$$
q_R = q_{i+1} - \frac{1}{2}\sigma_{i+1}
$$

### 4.5 CFL条件与时间步长

**CFL条件（Courant-Friedrichs-Lewy条件）**是显式时间积分方案稳定性的必要条件。

#### 4.5.1 对流CFL条件

$$
\Delta t_{conv} \leq \text{CFL}_{conv} \cdot \frac{\min(\Delta x, \Delta y)}{|u| + |v| + c}
$$

其中$$u$$和$$v$$是全局最大水平和垂直速度。

信息（声波和流体）在一个时间步内的传播距离不能超过一个网格尺寸。这是显然的，因为物理相互作用是局部的。

#### 4.5.2 扩散CFL条件

当启用粘性模拟时，还需满足扩散稳定性条件：

$$
\Delta t_{visc} \leq \text{CFL}_{visc} \cdot \frac{\rho \cdot \min(\Delta x, \Delta y)^2}{\mu}
$$

或者用运动粘性系数 $\nu = \mu/\rho$ 表示：

$$
\Delta t_{visc} \leq \text{CFL}_{visc} \cdot \frac{\min(\Delta x, \Delta y)^2}{\nu}
$$

此限制条件本人从[此处](https://www.reddit.com/r/CFD/comments/6ltjmd/cfl_condition_for_compressible_navierstokes/?tl=zh-hans)得知。

扩散过程的稳定性要求时间步与网格尺寸的**平方**成正比。这意味着当网格加密时，粘性CFL限制比对流CFL更加严格。

实际时间步取两者的较小值：

$$
\Delta t = \min(\Delta t_{conv}, \Delta t_{visc})
$$

### 4.6 对流扩散分离法

将对流和扩散过程分开求解。因为物理量分为扩散量和对流量。

将方程 $\partial \mathbf{U}/\partial t = \mathcal{L}_{conv}(\mathbf{U}) + \mathcal{L}_{visc}(\mathbf{U})$ 分解为：

- **对流算子** $\mathcal{L}_{conv}$：使用现有的MUSCL+HLLC高阶格式
- **扩散算子** $\mathcal{L}_{visc}$：使用中心差分（二阶精度，对称）

### 4.7 浸没边界法

#### 4.7.1 基本思想

在物体边界附近，我们将紧邻物体的单元标记为"Ghost Cell"。
Ghost Cell的物理量不通过守恒方程计算，而是通过边界条件从相邻流体单元外推得到。
可以理解为以以下方式对格子分类：

```
 FLUID  │  GHOST  │  SOLID
```

#### 4.7.2 确定表面方向

通过SDF梯度计算表面法向量：

$$
\mathbf{n} = \frac{\nabla \phi}{|\nabla \phi|}
$$

其中$\phi$是SDF。法向量指向流体侧（SDF增大的方向）。

#### 4.7.3 速度边界情况：无滑移

**无滑移边界（No-slip）**：速度在壁面处为零（粘性流动默认）

$$
\mathbf{v}_{wall} = 0
$$

Ghost单元速度设为流体速度的镜像：

$$
\mathbf{v}_{ghost} = -\mathbf{v}_{fluid}
$$

#### 4.7.4 速度边界情况：可滑移

**滑移边界（Slip）**：只有法向速度为零（无粘流动使用）

$$
v_n = 0, \quad v_t \neq 0
$$

Ghost单元法向速度镜像，切向速度保持：

$$
v_{n,ghost} = -v_{n,fluid}, \quad v_{t,ghost} = v_{t,fluid}
$$

#### 4.7.5 温度边界条件：绝热

**绝热壁面（Adiabatic）**：壁面无热量传递（默认）

$$
\frac{\partial T}{\partial n} = 0
$$

Ghost单元温度等于流体温度：

$$
T_{ghost} = T_{fluid}
$$

#### 4.7.6 温度边界条件：等温

**等温壁面（Isothermal）**：壁面温度固定为 $T_{wall}$

$$
T_{wall} = \frac{T_{fluid} + T_{ghost}}{2}
$$

因此：

## 5. 代码实现规划

每一步更新称为一个步长（Step），对应于 `CFDSolver::step(SimParams &params)`

先确定计算流程，以便定义函数。

### 5.1 无粘性Euler方程

```
1. 计算原始变量 (computePrimitivesKernel) 
2. 计算数值通量 (computeFluxesKernel)
	MUSCL重构 → 界面左右状态
	HLLC/HLL黎曼求解 → 界面通量
	计算内能通量
3. 更新守恒变量 (updateKernel) 
	通量差分
	欧拉前进
	双能量同步
	物理量限制（正性保持）
4. 交换缓冲区
5. 应用边界条件（applyBoundaryConditionsKernel）
	入流边界（固定来流条件）
	出流边界（零梯度外推）
	上下边界（非反射边界）
	Ghost Cell边界（滑移/无滑移混合）
6. 更新时间 t += dt
```

### 5.2 有粘性Navier-Stokes方程

```
1. 扩散半步 dt/2
	1a. 计算原始变量 (computePrimitivesKernel)
    1b. 计算粘性系数场 (computeViscosityKernel)
        使用Sutherland公式
    1c. 计算应力张量 (computeStressTensorKernel)
    1d. 计算热通量 (computeHeatFluxKernel)
        使用Fourier定律
    1e. 扩散积分 (diffusionStepKernel, dt/2)
        更新的粘性贡献 
2. 对流全步 dt
    2a. 计算原始变量 (computePrimitivesKernel)
    2b. 计算对流通量 (computeFluxesKernel)
    	MUSCL重构 → 界面左右状态
        HLLC/HLL黎曼求解 → 界面通量
        计算内能通量
    2c. 更新守恒变量 (updateKernel)
    	通量差分
        欧拉前进
        双能量同步
        物理量限制
    2d. 交换缓冲区
3. 扩散半步 dt/2
	3a. 计算原始变量 (computePrimitivesKernel)
    3b. 计算粘性系数场 (computeViscosityKernel)
        使用Sutherland公式
    3c. 计算应力张量 (computeStressTensorKernel)
    3d. 计算热通量 (computeHeatFluxKernel)
        使用Fourier定律
    3e. 扩散积分 (diffusionStepKernel, dt/2)
        更新的粘性贡献
4. 交换缓冲区
5. 应用边界条件（applyBoundaryConditionsKernel）
	入流边界（固定来流条件）
	出流边界（零梯度外推）
	上下边界（非反射边界）
	Ghost Cell边界（滑移/无滑移混合）
6. 更新时间 t += dt
```

## 6. 代码中物理量表

### 6.1 守恒物理量

**守恒变量（Conservative Variables）**：直接参与守恒方程的变量，由显存持久化存储。

以下的密度均为相对体积而言的密度。

| 代码变量名 | 数学符号 | 含义详解 (位置、方向、依赖关系)                              | 来源 (生成者) | 用途 (消费者) |
| ---------- | -------- | ------------------------------------------------------------ | ------------- | ------------- |
| `rho`      | $\rho$   | **【位置】中心** <br/> **【含义】** 方格内气体密度。 <br/> **【依赖】** 由显存存储，作为整个求解器维护的对象。 |               |               |
| `rho_u`    | $\rho u$ | **【位置】中心** <br/> **【含义】** x轴方向动量密度。 <br/> **【依赖】** 由显存存储，作为整个求解器维护的对象。 |               |               |
| `rho_v`    | $\rho v$ | **【位置】中心** <br/> **【含义】** y轴方向动量密度。 <br/> **【依赖】** 由显存存储，作为整个求解器维护的对象。 |               |               |
| `E`        | $E$      | **【位置】中心** <br/> **【含义】** 能量密度。 <br/> **【依赖】** 由显存存储，作为整个求解器维护的对象。 |               |               |

### 6.2 中间物理量

| 结构       | 含义                   | 例子                                                         |
| :--------- | :--------------------- | :----------------------------------------------------------- |
| **前缀**   | 变量的类型             | `flux_` (通量), `d_` (设备端数组), `dFx_` (通量的空间导数/变化率) |
| **物理量** | 这个变量里装着什么成分 | `rho` (质量), `rho_u` (x动量), `rho_v` (y动量), `E` (能量)   |
| **后缀**   | 这个变量归哪个方向管   | `_x` (管左右进出), `_y` (管上下进出), 没后缀 (表示标量或中心量) |


| 代码变量名                            | 数学符号                        | 含义详解 (位置、方向、依赖关系)                              | 来源 (生成者)                             | 用途 (消费者)                                                |
| :------------------------------------ | :------------------------------ | :----------------------------------------------------------- | :---------------------------------------- | :----------------------------------------------------------- |
| **1. 原始变量 (Primitives)**          |                                 | 相比于守恒变量更直观，但不适合维护。                         |                                           |                                                              |
| `d_u`, `d_v`                          | $u, v$                          | **【位置】中心** <br> **【含义】** 气流速度矢量。 <br> **【依赖】** 仅依赖当前格子的 $\rho, \rho u, \rho v$。 | `computePrimitivesKernel`                 | 1. `computeViscosity` <br> 2. `computeStressTensor` <br> 3. `computeFluxes` (重构用) |
| `d_p`                                 | $p$                             | **【位置】中心** <br> **【含义】** 热力学压强（各向同性，即向各个方向推力一样）。 <br> **【依赖】** 当前格子的 $E$ 和动能。 | `computePrimitivesKernel`                 | 1. `computeFluxes` (黎曼求解) <br> 2. `applyBoundary`        |
| `d_T`                                 | $T$                             | **【位置】中心** <br> **【含义】** 温度。 <br> **【依赖】** 状态方程 $P=\rho R T$。 | `computePrimitivesKernel`                 | 1. `computeViscosity` <br> 2. `computeHeatFlux`              |
| **2. 物性参数 (Navier-Stokes)**       |                                 |                                                              |                                           |                                                              |
| `d_mu`                                | $\mu$                           | **【位置】中心** <br> **【含义】** 动力粘度（流体有多稠）。 <br> **【依赖】** 当前格子的 $T$ (Sutherland公式)。 | `computeViscosityKernel`                  | `computeStressTensor`                                        |
| `d_k`                                 | $k$                             | **【位置】中心** <br> **【含义】** 热导率（传热有多快）。 <br> **【依赖】** 当前格子的 $\mu$。 | `computeViscosityKernel`                  | `computeHeatFlux`                                            |
| **3. 梯度项 (Navier-Stokes)**         |                                 |                                                              |                                           |                                                              |
| `tau_xx`, `tau_yy`                    | $\tau_{xx}, \tau_{yy}$          | **【位置】中心** <br> **【含义】** 正应力（拉伸/压缩）。因为速度场不均匀导致格子被拉长或压扁的内部摩擦力。 <br> **【依赖】** **上下左右邻居**的速度 (计算 $\partial u/\partial x$ 等)。 | `computeStressTensorKernel`               | `diffusionStepKernel`                                        |
| `tau_xy`                              | $\tau_{xy}$                     | **【位置】中心** <br> **【含义】** **切应力（剪切）**。最关键的粘性项。代表x动量在y方向传递的摩擦力。 <br> **【依赖】** **上下左右邻居**的速度。 | `computeStressTensorKernel`               | `diffusionStepKernel`                                        |
| `qx`, `qy`                            | $q_x, q_y$                      | **【位置】中心** <br> **【含义】** 热通量**矢量**。 <br> - `qx`: 热量向右流动的速度。 <br> - `qy`: 热量向上流动的速度。 <br> **【依赖】** **邻居**的温度梯度 $\nabla T$。 | `computeHeatFluxKernel`                   | `diffusionStepKernel`                                        |
| **4. 重构状态 (Flux Prep)**           |                                 | *注：这些通常是核函数内的临时变量，不持久存储*               |                                           |                                                              |
| `rhoL`, `uL`, `pL`                    | $U_L$                           | **【位置】右界面 ($i+1/2$) 的左侧** <br> **【含义】** 从格子 $i$ 内部推算到其右墙的状态值。 <br> **【依赖】** 格子 $i-1, i, i+1$ (MUSCL斜率)。 | `computeFluxesKernel` (内部)              | 黎曼求解器 (HLLC)                                            |
| `rhoR`, `uR`, `pR`                    | $U_R$                           | **【位置】右界面 ($i+1/2$) 的右侧** <br> **【含义】** 从格子 $i+1$ 内部反推回其左墙的状态值。 <br> **【依赖】** 格子 $i, i+1, i+2$。 | `computeFluxesKernel` (内部)              | 黎曼求解器 (HLLC)                                            |
| **5. 数值通量 (Numerical Fluxes)**    |                                 | **这是最核心的中间量**                                       |                                           |                                                              |
| `d_flux_..._x` <br> (如 `flux_rho_x`) | $\mathbf{F}_{i+1/2}$            | **【位置】右界面 ($i+1/2$)** <br> **【方向】** 垂直于界面向右。 <br> **【含义】** 单位时间**穿过这道墙**的物理量。 <br> - `flux_rho_x`: 穿墙的质量。 <br> - `flux_rho_u_x`: 穿墙的x动量(主要) + 墙上的压力。 <br> - `flux_rho_v_x`: 穿墙的y动量(被横风带走的侧向动量)。 <br> **【依赖】** 左侧 $i$ 和右侧 $i+1$ 的重构状态。 | `computeFluxesKernel` (`flux_rho_x[idx]`) | `updateKernel`                                               |
| `d_flux_..._y` <br> (如 `flux_rho_y`) | $\mathbf{G}_{j+1/2}$            | **【位置】上界面 ($j+1/2$)** <br> **【方向】** 垂直于界面向上。 <br> **【含义】** 单位时间**穿过天花板**的物理量。 <br> - `flux_rho_y`: 穿过天花板的质量。 <br> - `flux_rho_u_y`: 穿过天花板的x动量(被上升气流带走的横向动量)。 <br> **【依赖】** 下方 $j$ 和上方 $j+1$ 的重构状态。 | `computeFluxesKernel` (`flux_rho_y[idx]`) | `updateKernel`                                               |
| **6. 散度/残差 (Update Terms)**       |                                 | *注：这是 updateKernel 内计算的临时量*                       |                                           |                                                              |
| `dFx`                                 | $\frac{\partial F}{\partial x}$ | **【位置】中心** <br> **【含义】** X方向净流出量。 <br> **【算法】** (右界面通量 - 左界面通量) / dx。 <br> **【注意】** 左界面通量实际上就是 `flux_x[i-1]`。 | `updateKernel` (内部)                     | 更新守恒变量                                                 |
| `dFy`                                 | $\frac{\partial F}{\partial y}$ | **【位置】中心** <br> **【含义】** Y方向净流出量。 <br> **【算法】** (上界面通量 - 下界面通量) / dy。 <br> **【注意】** 下界面通量实际上就是 `flux_y[j-1]`。 |                                           |                                                              |

## 7. 修复：边界无反射条件构造

为了实现NRBC（无反射边界），需要使用黎曼不变量。一维，无粘性Euler方程有以下四个不变量：

**对应 $\lambda = v$ (熵波)**：

$$
I_1 = S = \frac{p}{\rho^\gamma} \quad (\text{或者简单理解为熵})
$$

**对应 $\lambda = v$ (剪切波)**：

$$
I_2 = u \quad (\text{水平速度是跟着流体垂直漂移的})
$$

**对应 $\lambda = v + c$ (向上声波)**：

$$
J^+ = v + \frac{2c}{\gamma - 1}
$$

**对应 $\lambda = v - c$ (向下声波)**：

$$
J^- = v - \frac{2c}{\gamma - 1}
$$

## 8. 补充：关于优化

### 7.1 双能量方法

气体速度非常快的时候，动能占总能量比例很高，如果只记录总能量，那么为了获得用于计算温度的内能值，算法需要用一个非常大的总能量`float`减去一个非常大的动能`float`，会导致数值不稳定。

气体压强非常低的时候，理想气体假设逐渐失效，气体表现得像是非常快速运动，但是相撞不频繁的粒子云。这个时候算法会用一个非常小的总能量`float`减去一个非常小的动能`float`，浮点数运算误差会导致尾流区域温度被估计到极高（引入前程序出现过的最高值为15000K，这是不可能的）。

因此需要额外维护一个气体状态量（网格内气体内能密度`d_rho_e_` ）

这个状态量的更新依赖于以下方程：
$$
\frac{\partial{(\rho e)}}{\partial t}+\nabla\cdot(\rho e\bold{u})=-p(\nabla\cdot\bold{u})
$$
可以理解为：
在每个无穷小的时间段内：

- 每个单元格都有一个内能密度的变化量（第一项）
- 由于气体流动（流入或流出），会有一个对流项（第二项），描述被气体速度散度所带走的内能密度
- 由于气体可压缩，速度散度也代表了气体正在膨胀还是收缩，根据理想气体状态方程，这会产生内能变化（右侧项）
- 第一项就是通过第二项和第三项计算出来的。

由于这个方程没有考虑摩擦生热（或任何动能转化为内能的机制），它在本场景下并不绝对的物理正确，存在误差，但是当气体非常稀薄或者速度非常快的时候，它比基本算法（总能量）更合理，不会出现极端高温。

这也可以减少为了获得内能，用总能量减去动能的几次浮点运算。

此方法的实现表现为在`updateKernel()`函数中的以下几行：


```cpp
// 1. 计算速度散度 div(v)
float div_v = du_dx + dv_dy;
// 2. 源项: d(rho*e)/dt = -p * div(v)
float source_rho_e = -p_c * div_v;

// balabala

// 3. 内能方程更新：旧值 - 通量散度 + 源项
float new_rho_e = rho_e[idx] - dt * (dFx_rho_e + dFy_rho_e) + dt * source_rho_e;
```

## 9. 参考资料

### 9.1 知乎

[知乎-有限体积法](https://zhuanlan.zhihu.com/p/331771977)

[知乎-黎曼问题](https://zhuanlan.zhihu.com/p/20860650#:~:text=4.%20%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98%20*%20%E4%B8%8A%E9%9D%A2%E6%8E%A8%E5%80%92%E4%B8%AD%EF%BC%8C%E9%83%BD%E9%87%87%E7%94%A8%E4%BA%86%E5%BD%93%E5%9C%B0%E7%BA%BF%E5%8C%96%EF%BC%8C%E8%BF%99%E4%B9%9F%E5%B0%B1%E6%98%AF%E4%B8%BA%E4%BB%80%E4%B9%88Roe%E6%A0%BC%E5%BC%8F%E7%AD%89%E7%A7%B0%E4%B8%BA%E8%BF%91%E4%BC%BCRiemann%E8%A7%A3%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%8C%E7%B2%BE%E7%A1%AERiemann%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%88%90%E6%9C%AC%E5%A4%AA%E9%AB%98%E3%80%82%20*%20%5Ctilde%7BA%7D%20%E7%9A%84%E8%AE%A1%E7%AE%97%E6%96%B9%E5%BC%8F%E3%80%82,%E9%82%A3%E4%B9%88%E9%80%9A%E8%BF%87%E8%A7%A3%E8%BF%99%E4%B8%AA%E6%96%B9%E7%A8%8B%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%A1%AE%E5%AE%9A%5Ctilde%7BA%7D%20%E7%9A%84%E5%85%B7%E4%BD%93%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%EF%BC%8C%5Ctilde%7BA%7D%20%E6%98%AFU_%7BL%7D%2CU_%7BR%7D%E7%9A%84%E5%87%BD%E6%95%B0%E3%80%82%20*%20%E7%94%B1%E4%BA%8E%E5%89%8D%E6%96%87%E7%9A%84%E6%8E%A8%E5%80%92%E6%98%AF%E9%92%88%E5%AF%B9%E4%B8%80%E7%BB%B4Euler%E6%96%B9%E7%A8%8B%EF%BC%8C%E6%89%80%E4%BB%A5%E5%AE%9E%E9%99%85%E8%AE%A1%E7%AE%97%E4%B8%AD%EF%BC%8C%E9%83%BD%E8%A6%81%E9%87%87%E7%94%A8%E7%BD%91%E6%A0%BC%E8%BE%B9%E7%9A%84%E5%BD%93%E5%9C%B0%E5%9D%90%E6%A0%87%E7%B3%BB%EF%BC%8C%E4%B9%9F%E5%8D%B3%E8%AE%A4%E4%B8%BA%E6%B2%BF%E7%9D%80%E7%BD%91%E6%A0%BC%E8%BE%B9%EF%BC%88%E9%9D%A2%EF%BC%89%E6%B3%95%E5%90%91%E4%BC%A0%E6%92%AD%EF%BC%88%E4%B8%80%E7%BB%B4%E8%BF%91%E4%BC%BC%EF%BC%89%EF%BC%8C%E5%85%B6%E4%BB%96%E6%96%B9%E5%90%91%E7%9A%84%E9%87%8F%E4%BD%9C%E4%B8%BA%E8%A2%AB%E5%8A%A8%E6%A0%87%E9%87%8F%E3%80%82%20*%20U_%7BL%7D%2CU_%7BR%7D%E6%80%8E%E4%B9%88%E8%AE%A1%E7%AE%97%EF%BC%8C%E5%B0%86%E5%9C%A8%E4%B8%8B%E4%B8%80%E7%AF%87%E4%BB%8B%E7%BB%8D%E3%80%82)

[知乎-CUDA共享内存](https://zhuanlan.zhihu.com/p/659430546)

### 9.2 Roe 平均的严格表述

在求解 Riemann 问题（确定网格界面通量）时，如何合理估计界面状态是一个核心问题。对于跨音速流动和激波管问题，简单的算术平均（$0.5(U_L + U_R)$）会产生错误的波速估计，导致激波位置错误或非物理振荡。

Philip Roe (1981) 提出了一种特殊的平均方法，寻找一个线性化的 Jacobian 矩阵 $\tilde{A}(U_L, U_R)$，使得该矩阵满足以下“Roe 性质”：

1. **双曲性**：$\tilde{A}$ 具有实特征值和线性独立的特征向量。
2. **一致性**：当 $U_L \to U_R \to U$ 时，$\tilde{A}(U_L, U_R) \to A(U)$。
3. **守恒性**：$\tilde{F}(U_L, U_R) = \frac{1}{2}(F_L + F_R) - \frac{1}{2}|\tilde{A}|(U_R - U_L)$，即 $\Delta F = \tilde{A} \Delta U$。这意味着如果界面正好位于激波上，Roe 平均能精确捕捉激波跳跃条件（Rankine-Hugoniot 关系）。

为了满足性质3，必须使用特定的权重 $\sqrt{\rho}$ 进行加权平均（证明省略）。
本项目的求解器（HLLC 和 HLL）在计算波速时使用了 Roe 平均状态，具体公式如下：

**1. 定义权重**
首先计算左右状态密度的平方根比值权重：

$$
\sqrt{\rho_L} = \sqrt{\rho_L}, \quad \sqrt{\rho_R} = \sqrt{\rho_R}
$$

**2. 速度场的 Roe 平均**
速度分量使用 $\sqrt{\rho}$ 加权：

$$
\tilde{u} = \frac{\sqrt{\rho_L} u_L + \sqrt{\rho_R} u_R}{\sqrt{\rho_L} + \sqrt{\rho_R}}
$$

$$
\tilde{v} = \frac{\sqrt{\rho_L} v_L + \sqrt{\rho_R} v_R}{\sqrt{\rho_L} + \sqrt{\rho_R}}
$$

**3. 焓的 Roe 平均**
总焓（Total Enthalpy）$H = (E + p) / \rho$ 也遵循同样的加权：

$$
\tilde{H} = \frac{\sqrt{\rho_L} H_L + \sqrt{\rho_R} H_R}{\sqrt{\rho_L} + \sqrt{\rho_R}}
$$

**4. 导出声速**
Roe 平均声速 $\tilde{c}$ 不是直接对 $c_L$ 和 $c_R$ 平均，而是从平均焓和平均动能导出，以保持能量守恒的一致性：

$$
\tilde{c}^2 = (\gamma - 1) (\tilde{H} - \frac{1}{2}(\tilde{u}^2 + \tilde{v}^2))
$$

$$
\tilde{c} = \sqrt{\tilde{c}^2}
$$

**在求解器中的应用**：
我们在 `hllFluxX`、`hllcFluxX`、`hllFluxY` 和 `hllcFluxY` 函数中均使用了这组平均量来估算界面的波速（Signal Velocities）：

- 左波速 $S_L = \min(u_L - c_L, \tilde{u} - \tilde{c})$
- 右波速 $S_R = \max(u_R + c_R, \tilde{u} + \tilde{c})$
