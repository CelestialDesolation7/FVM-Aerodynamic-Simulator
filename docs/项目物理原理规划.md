# 气动热仿真项目物理原理

## 1. 项目概述

### 1.1 仿真场景

本项目模拟的是**二维气流绕障碍物流动**的物理现象。具体场景为：

- 空气从计算域左侧以水平流入
- 计算域中央放置一个障碍物（圆形、星形、菱形等）
- 气流撞击障碍物后产生**激波**（shock wave）
- 激波后方的气体被压缩和加热，温度显著升高
- 障碍物后方形成**尾流**区域

### 1.2 物理现象

当超音速气流撞击障碍物时，会产生以下关键物理现象：

1. **弓形激波（Bow Shock）**：在物体前方形成弧形激波，气体穿过激波时被急剧压缩和加热
2. **驻点加热**：物体正前方（驻点）温度最高，因为气体在此处几乎停滞，动能完全转化为热能
3. **压力分布**：物体前方压力最高，向两侧和后方逐渐降低
4. **尾流**：物体后方形成低压、低密度的尾流区域，一道红色长线

**启用粘性模拟后的额外现象**：

5. **边界层**：在物体表面附近形成速度梯度较大的薄层，流体从壁面的零速度过渡到主流速度
6. **壁面热流**：热量通过热传导从高温流体传递到壁面，可计算气动加热率
7. **粘性耗散**：流体内部的摩擦将动能转化为热能，尤其在边界层内显著

---

## 2. 物理量定义

### 2.1 基本物理量整理

核心物理量：

| 符号   | 名称       | 单位   | 物理含义                            |
| ------ | ---------- | ------ | ----------------------------------- |
| $\rho$ | 密度       | kg/m³  | 单位体积内气体的质量                |
| $u$    | x方向速度  | m/s    | 气体沿水平方向的运动速度            |
| $v$    | y方向速度  | m/s    | 气体沿垂直方向的运动速度            |
| $p$    | 压强       | Pa     | 单位面积上气体施加的力              |
| $T$    | 温度       | K      | 气体的热力学温度                    |
| $E$    | 总能量密度 | J/m³   | 单位体积内气体的总能量（内能+动能） |
| $e$    | 比内能     | J/kg   | 单位质量气体的内能                  |
| $c$    | 声速       | m/s    | 声波在气体中传播的速度              |
| $Ma$   | 马赫数     | 无量纲 | 流速与声速之比                      |

**粘性流动相关物理量**（启用粘性模拟时）：

| 符号        | 名称         | 单位    | 物理含义                                  |
| ----------- | ------------ | ------- | ----------------------------------------- |
| $\mu$       | 动力粘性系数 | Pa·s    | 流体抵抗剪切变形的能力                    |
| $\nu$       | 运动粘性系数 | m²/s    | $\nu = \mu/\rho$，动量扩散系数            |
| $k$         | 热导率       | W/(m·K) | 热量传导的能力                            |
| $\tau_{ij}$ | 粘性应力张量 | Pa      | 流体内部由于速度梯度产生的应力            |
| $q_x, q_y$  | 热通量       | W/m²    | 单位面积单位时间传递的热量                |
| $Re$        | 雷诺数       | 无量纲  | $Re = \rho u L / \mu$，惯性力与粘性力之比 |
| $Pr$        | 普朗特数     | 无量纲  | $Pr = \mu C_p / k$，动量扩散与热扩散之比  |

### 2.2 物理常数

代码中定义的物理常数（位于`common.h`）：

```cpp
constexpr float GAMMA = 1.4f;    // 比热比（空气）
constexpr float R_GAS = 287.05f; // 空气的比气体常数 [J/(kg·K)]
constexpr float CV = R_GAS / (GAMMA - 1.0f);  // 定容比热
constexpr float CP = GAMMA * CV;              // 定压比热

// Sutherland公式常数（用于计算粘性系数）
constexpr float MU_REF = 1.716e-5f;    // 参考粘性系数 [Pa·s]
constexpr float T_REF = 273.15f;       // 参考温度 [K]
constexpr float S_SUTHERLAND = 110.4f; // Sutherland常数 [K]

// 普朗特数
constexpr float PR = 0.72f;  // 空气的普朗特数
```

**物理解释**：

- **比热比 γ（GAMMA）**：定压比热与定容比热之比，对于双原子气体（如空气）约为1.4。
- **比气体常数 R**：与气体分子量相关，空气约为287 J/(kg·K)。
- **定容比热 $C_v$**：保持体积不变时，使单位质量气体升温1K所需的热量。
- **定压比热 $C_p$**：保持压力不变时，使单位质量气体升温1K所需的热量。
- **Sutherland常数**：用于计算温度相关的粘性系数。
- **普朗特数 Pr**：动量扩散率与热扩散率之比，对于空气约为0.72。

### 2.3 守恒变量与原始变量

在此CFD中，我们区分两种变量形式：

**守恒变量（Conservative Variables）**：直接参与守恒方程的变量
$$
\mathbf{U} = \begin{pmatrix} \rho \\ \rho u \\ \rho v \\ E \end{pmatrix}
$$

- $\rho$：质量密度
- $\rho u$：x方向动量密度
- $\rho v$：y方向动量密度
- $E$：总能量密度

**原始变量（Primitive Variables）**：更直观的物理量
$$
\mathbf{W} = \begin{pmatrix} \rho \\ u \\ v \\ p \end{pmatrix}
$$

守恒方程本质上描述的是质量、动量、能量的守恒。
使用守恒形式的变量可以确保数值计算过程中这些物理量在全局范围内守恒。

### 2.4 能量的定义

**总能量密度 E**：
$$
E = \rho e + \frac{1}{2}\rho(u^2 + v^2)
$$

其中：

- $\rho e$ 是内能密度（与温度相关的热能）
- $\frac{1}{2}\rho(u^2 + v^2)$ 是动能密度

**内能与温度、压强的关系**（对于理想气体）：
$$
e = C_v T = \frac{p}{(\gamma-1)\rho}
$$

因此：
$$
\rho e = \frac{p}{\gamma - 1}
$$

---

## 3. 基本物理原理

注意：本项目涉及且仅涉及到以下方程。

每个条目的第一条都是原始方程，下面的都是在解释。

### 3.1 欧拉方程组（主控制方程）

**二维无粘可压缩欧拉方程**是Navier-Stokes方程在忽略粘性的简化形式，适用于高速流动中粘性效应相对较小的情况。

**守恒形式的欧拉方程**：
$$
\frac{\partial \mathbf{U}}{\partial t} + \frac{\partial \mathbf{F}}{\partial x} + \frac{\partial \mathbf{G}}{\partial y} = 0
$$

其中 $\mathbf{U}$ 是守恒变量向量，$\mathbf{F}$ 和 $\mathbf{G}$ 分别是x方向和y方向的通量向量。

**展开形式**：

**质量守恒方程**：
$$
\frac{\partial \rho}{\partial t} + \frac{\partial (\rho u)}{\partial x} + \frac{\partial (\rho v)}{\partial y} = 0
$$

某区域内质量的变化率等于流入和流出该区域的质量之差。

**x方向动量守恒方程**：
$$
\frac{\partial (\rho u)}{\partial t} + \frac{\partial (\rho u^2 + p)}{\partial x} + \frac{\partial (\rho u v)}{\partial y} = 0
$$

动量的变化由动量的输运（流体携带动量进出）和压力做功共同决定。

**y方向动量守恒方程**：
$$
\frac{\partial (\rho v)}{\partial t} + \frac{\partial (\rho u v)}{\partial x} + \frac{\partial (\rho v^2 + p)}{\partial y} = 0
$$

**能量守恒方程**：
$$
\frac{\partial E}{\partial t} + \frac{\partial [(E + p)u]}{\partial x} + \frac{\partial [(E + p)v]}{\partial y} = 0
$$

能量的变化由能量的输运和压力做功共同决定。$(E+p)u$ 表示流体在流动时不仅携带能量E，还需要克服压力做功。

---

### 3.2 Navier-Stokes方程（主控制方程）

当启用粘性模拟时，控制方程从欧拉方程扩展为**可压缩Navier-Stokes方程**：

$$
\frac{\partial \mathbf{U}}{\partial t} + \nabla \cdot \mathbf{F}_{conv} = \nabla \cdot \mathbf{F}_{visc}
$$

其中 $\mathbf{F}_{conv}$ 是对流通量（与欧拉方程相同），$\mathbf{F}_{visc}$ 是粘性通量。

**展开形式**：

由于粘性效应的引入，动量方程和能量方程的右端增加了粘性项：

**质量守恒方程**（与欧拉方程相同）：
$$
\frac{\partial \rho}{\partial t} + \frac{\partial (\rho u)}{\partial x} + \frac{\partial (\rho v)}{\partial y} = 0
$$

**x方向动量守恒方程**：
$$
\frac{\partial (\rho u)}{\partial t} + \frac{\partial (\rho u^2 + p)}{\partial x} + \frac{\partial (\rho u v)}{\partial y} = \frac{\partial \tau_{xx}}{\partial x} + \frac{\partial \tau_{xy}}{\partial y}
$$

流体微团动量的变化不仅受压力和对流影响，还受到内部粘性摩擦力（应力张量的散度）的作用。右端项代表了粘性力在x方向上的合力。

**y方向动量守恒方程**：
$$
\frac{\partial (\rho v)}{\partial t} + \frac{\partial (\rho u v)}{\partial x} + \frac{\partial (\rho v^2 + p)}{\partial y} = \frac{\partial \tau_{xy}}{\partial x} + \frac{\partial \tau_{yy}}{\partial y}
$$

**能量守恒方程**：
$$
\frac{\partial E}{\partial t} + \frac{\partial [(E + p)u]}{\partial x} + \frac{\partial [(E + p)v]}{\partial y} = \frac{\partial}{\partial x}(u\tau_{xx} + v\tau_{xy} - q_x) + \frac{\partial}{\partial y}(u\tau_{xy} + v\tau_{yy} - q_y)
$$

总能量的变化增加了两部分来源：

1. **粘性做功**（$u\tau_{xx} + v\tau_{xy}$ 等）：粘性力对流体做功，将机械能转化为内能（摩擦生热）。
2. **热传导**（$-q_x, -q_y$）：热量因温度差异而流入或流出的贡献（$q$是热流密度，$-\nabla \cdot \mathbf{q}$ 为热量净流入）。

粘性应力张量描述了由于速度梯度引起的内部摩擦力：

$$
\tau_{xx} = \mu \left( 2\frac{\partial u}{\partial x} - \frac{2}{3}\nabla \cdot \mathbf{v} \right)
$$

$$
\tau_{yy} = \mu \left( 2\frac{\partial v}{\partial y} - \frac{2}{3}\nabla \cdot \mathbf{v} \right)
$$

$$
\tau_{xy} = \mu \left( \frac{\partial u}{\partial y} + \frac{\partial v}{\partial x} \right)
$$

其中 $\nabla \cdot \mathbf{v} = \frac{\partial u}{\partial x} + \frac{\partial v}{\partial y}$ 是速度散度。

详细解释见[知乎的这篇文章](https://zhuanlan.zhihu.com/p/381804810)。

**自然语言解释**：

- $\tau_{xx}$ 和 $\tau_{yy}$ 是正应力，描述了流体在各方向上被拉伸或压缩时产生的阻力
- $\tau_{xy}$ 是剪切应力，描述了相邻流体层之间由于速度差异而产生的摩擦力
- $-\frac{2}{3}\nabla \cdot \mathbf{v}$ 项是Stokes假设（体积粘性为零）的结果

---

### 3.3 Sutherland粘性公式

空气的粘性系数随温度变化，使用**Sutherland公式**计算：

$$
\mu = \mu_{ref} \left( \frac{T}{T_{ref}} \right)^{3/2} \frac{T_{ref} + S}{T + S}
$$

其中：

- $\mu_{ref} = 1.716 \times 10^{-5}$ Pa·s（参考粘性系数）
- $T_{ref} = 273.15$ K（参考温度）
- $S = 110.4$ K（Sutherland常数）

温度越高，分子运动越剧烈，粘性系数越大。Sutherland公式是基于气体分子动力学理论的**经验公式**。

热导率通过普朗特数计算：
$$
k = \frac{\mu C_p}{Pr}
$$

---

### 3.4 粘性通量

x方向粘性通量：
$$
\mathbf{F}_{visc,x} = \begin{pmatrix} 0 \\ \tau_{xx} \\ \tau_{xy} \\ u\tau_{xx} + v\tau_{xy} - q_x \end{pmatrix}
$$

y方向粘性通量：
$$
\mathbf{F}_{visc,y} = \begin{pmatrix} 0 \\ \tau_{xy} \\ \tau_{yy} \\ u\tau_{xy} + v\tau_{yy} - q_y \end{pmatrix}
$$

**物理意义**：

- 质量方程无粘性项（粘性不产生质量）
- 动量方程的粘性项是应力张量的散度
- 能量方程包含粘性做功（$u\tau_{xx} + v\tau_{xy}$等）和热传导（$-q_x, -q_y$）

---

### 3.5 理想气体状态方程

理想气体状态方程将压强、密度和温度联系起来：
$$
p = \rho R T
$$

气体的压强与密度和温度成正比。温度越高或密度越大，气体分子运动越剧烈或碰撞越频繁，压强就越大。

由此可以推导温度：
$$
T = \frac{p}{\rho R}
$$

---

### 3.6 声速公式

**声速**是压力波（如声波）在介质中传播的速度：
$$
c = \sqrt{\gamma \frac{p}{\rho}} = \sqrt{\gamma R T}
$$

**物理意义**：声速反映了气体的"弹性"程度。温度越高，分子运动越快，压力扰动传播也越快。

**马赫数**定义为流速与当地声速之比：
$$
Ma = \frac{|\mathbf{v}|}{c} = \frac{\sqrt{u^2+v^2}}{c}
$$

- $Ma < 1$：亚音速流动
- $Ma = 1$：音速流动
- $Ma > 1$：超音速流动

---

## 4. 场景建模

### 4.1 有限体积法

本项目采用**有限体积法（Finite Volume Method, FVM）**进行空间离散化。

将计算域划分为有限个控制体（网格单元），在每个控制体上对守恒方程进行积分。

对于上文描述的守恒方程：
$$
\frac{\partial \mathbf{U}}{\partial t} + \nabla \cdot \mathbf{F} = 0
$$

在单元 $(i,j)$ 上积分后得到：
$$
\frac{d\mathbf{U}_{i,j}}{dt} = -\frac{1}{\Delta x}(F_{i+1/2,j} - F_{i-1/2,j}) - \frac{1}{\Delta y}(G_{i,j+1/2} - G_{i,j-1/2})
$$

可以这样理解，单元内**守恒变量的变化率**（$$\frac{\partial \mathbf{U}}{\partial t}$$）等于通过该单元各边界面的净通量（也就是散度，$$\nabla \cdot \mathbf{F}$$)。
例如计算一个房间内空气量的变化——等于从各扇门窗进出的空气量之差。

### 4.2 黎曼求解器

在有限体积法中，计算单元界面上的通量是关键问题。由于相邻单元的状态可能不同，界面处实际上是一个**黎曼问题**，也就是一个初始状态存在间断的守恒律方程初值问题。

**警告：对于任何一种通量，其传播速度都无法超过音速。**

为了理解为什么引入，我们设想一个场景：

某两个单元格之间的一个竖着的界面，显然有一个通量，我们这里就假设是质量通量，即多少空气流入流出。

显然为了知道这个值，我们需要看看左右两个单元格内，空气的水平移动速度，这里假设两个格子空气质量一样。

于是我们可以知道，左右两个单元格中，分别打算通过这个界面传过多少物质。

因为空气可压缩，如果左边很快（输入1000m/s的大量空气），右边静滞，那么左右不会立刻像刚体碰撞一样改变速度（即左右都变成以500m/s的速度向右走），而是会出现，左边将右边压缩，右边被推走，逐渐压缩加速。

这时，显然通量应该仅仅由左侧格子决定。

对于更复杂的情况（即左右高速相撞或高速撕裂），则需要进入Case3：

二者的碰撞，在物理上会产生3个波，分别是向左和向右的冲击波（实际上严格来讲叫”激波“或”稀疏波“），以及中间的一道分界波（严格来说叫”熵波“）。于是我们需要临时将这个界面分为五个部分：

 ```
 左侧格子界面 - 向左冲击波 - 中间分界波 - 向右冲击波 - 右侧格子界面
 ```

我们要的通量就是中间分界波的物理状态。

通过黎曼求解器，可以用解析公式简单获得结果

#### 4.2.1 HLL求解器

**HLL（Harten-Lax-van Leer）求解器**是一种近似黎曼求解器，假设波系中只有两个波（最左和最右的波）。

波速估计：
$$
S_L = \min(u_L - c_L, u_R - c_R)
$$

$$
S_R = \max(u_L + c_L, u_R + c_R)
$$

其中下标L和R分别表示界面左右两侧的状态。

HLL通量公式：

- 若 $S_L \geq 0$（所有波都向右传播）：$\mathbf{F}_{1/2} = \mathbf{F}_L$
- 若 $S_R \leq 0$（所有波都向左传播）：$\mathbf{F}_{1/2} = \mathbf{F}_R$
- 否则（界面处于两波之间）：

$$
\mathbf{F}_{1/2} = \frac{S_R \mathbf{F}_L - S_L \mathbf{F}_R + S_L S_R (\mathbf{U}_R - \mathbf{U}_L)}{S_R - S_L}
$$

#### 4.2.2 HLLC求解器

**HLLC求解器**是HLL的改进版本，在两个声波之间额外考虑一个**接触间断波**（Contact Discontinuity），波速为 $S^*$。

接触间断波速度计算：
$$
S^* = \frac{p_R - p_L + \rho_L u_L (S_L - u_L) - \rho_R u_R (S_R - u_R)}{\rho_L (S_L - u_L) - \rho_R (S_R - u_R)}
$$

HLLC能更准确地处理接触间断（如密度突变但压力相同的情况），这在多物质流动或具有温度不连续的情况下特别重要。

### 4.3 MUSCL重构

为了获得更高的空间精度，本项目使用**MUSCL（Monotone Upstream-centered Schemes for Conservation Laws）**重构方法，将精度从一阶提升到二阶。

**基本思想**：不是将单元内的变量视为常数，而是假设变量在单元内线性变化，通过斜率限制器控制斜率以避免在间断处产生伪振荡。

其实就是线性插值，没什么好说的。

只是插值要避免一种特殊情况：中间值位于“波谷”或“波峰”，这个时候放弃插值，只能用低精度。

这种特殊情况通过$$ minmod(a,b) $$限制器实现；
$$
\text{minmod}(a, b) = \begin{cases}
\text{sign}(a) \cdot \min(|a|, |b|) & \text{if } ab > 0 \\
0 & \text{if } ab \leq 0
\end{cases}
$$
Minmod限制器的作用是"保守地估计斜率"。如果左右两侧的差分符号相反（说明这里可能是极值点），就将斜率设为0（这意味着我们放弃了使用斜率试图获得二阶精度）；
否则取较小的斜率，这样可以防止在激波处产生数值振荡。

**重构过程**（以x方向为例）：

界面左侧状态（从单元i外推到i+1/2）：
$$
q_L = q_i + \frac{1}{2}\sigma_i
$$

界面右侧状态（从单元i+1内推到i+1/2）：
$$
q_R = q_{i+1} - \frac{1}{2}\sigma_{i+1}
$$

### 4.5 CFL条件与时间步长

**CFL条件（Courant-Friedrichs-Lewy条件）**是显式时间积分方案稳定性的必要条件。

#### 4.5.1 对流CFL条件

$$
\Delta t_{conv} \leq \text{CFL}_{conv} \cdot \frac{\min(\Delta x, \Delta y)}{|u| + |v| + c}
$$

其中$$u$$和$$v$$是全局最大水平和垂直速度。

信息（声波和流体）在一个时间步内的传播距离不能超过一个网格尺寸。这是显然的，因为物理相互作用是局部的。

#### 4.5.2 扩散CFL条件

当启用粘性模拟时，还需满足扩散稳定性条件：

$$
\Delta t_{visc} \leq \text{CFL}_{visc} \cdot \frac{\rho \cdot \min(\Delta x, \Delta y)^2}{\mu}
$$

或者用运动粘性系数 $\nu = \mu/\rho$ 表示：

$$
\Delta t_{visc} \leq \text{CFL}_{visc} \cdot \frac{\min(\Delta x, \Delta y)^2}{\nu}
$$

此限制条件本人从[此处](https://www.reddit.com/r/CFD/comments/6ltjmd/cfl_condition_for_compressible_navierstokes/?tl=zh-hans)得知。

扩散过程的稳定性要求时间步与网格尺寸的**平方**成正比。这意味着当网格加密时，粘性CFL限制比对流CFL更加严格。

实际时间步取两者的较小值：
$$
\Delta t = \min(\Delta t_{conv}, \Delta t_{visc})
$$

### 4.6 对流扩散分离法

将对流和扩散过程分开求解。因为物理量分为扩散量和对流量。

将方程 $\partial \mathbf{U}/\partial t = \mathcal{L}_{conv}(\mathbf{U}) + \mathcal{L}_{visc}(\mathbf{U})$ 分解为：

- **对流算子** $\mathcal{L}_{conv}$：使用现有的MUSCL+HLLC高阶格式
- **扩散算子** $\mathcal{L}_{visc}$：使用中心差分（二阶精度，对称）

### 4.7 浸没边界法

#### 4.7.1 基本思想

在物体边界附近，我们将紧邻物体的单元标记为"Ghost Cell"。
Ghost Cell的物理量不通过守恒方程计算，而是通过边界条件从相邻流体单元外推得到。
可以理解为以以下方式对格子分类：

```
 FLUID  │  GHOST  │  SOLID
```

#### 4.7.2 确定表面方向

通过SDF梯度计算表面法向量：
$$
\mathbf{n} = \frac{\nabla \phi}{|\nabla \phi|}
$$

其中$\phi$是SDF。法向量指向流体侧（SDF增大的方向）。

#### 4.7.3 速度边界情况：无滑移

**无滑移边界（No-slip）**：速度在壁面处为零（粘性流动默认）
$$
\mathbf{v}_{wall} = 0
$$

Ghost单元速度设为流体速度的镜像：
$$
\mathbf{v}_{ghost} = -\mathbf{v}_{fluid}
$$

#### 4.7.4 速度边界情况：可滑移

**滑移边界（Slip）**：只有法向速度为零（无粘流动使用）
$$
v_n = 0, \quad v_t \neq 0
$$

Ghost单元法向速度镜像，切向速度保持：
$$
v_{n,ghost} = -v_{n,fluid}, \quad v_{t,ghost} = v_{t,fluid}
$$

#### 4.7.5 温度边界条件：绝热

**绝热壁面（Adiabatic）**：壁面无热量传递（默认）
$$
\frac{\partial T}{\partial n} = 0
$$

Ghost单元温度等于流体温度：
$$
T_{ghost} = T_{fluid}
$$

#### 4.7.6 温度边界条件：等温

**等温壁面（Isothermal）**：壁面温度固定为 $T_{wall}$
$$
T_{wall} = \frac{T_{fluid} + T_{ghost}}{2}
$$

因此：

## 5. 代码实现规划

每一步更新称为一个步长（Step），对应于 `CFDSolver::step(SimParams &params)`

先确定计算流程，以便定义函数。

### 5.1 无粘性Euler方程

```
1. 计算原始变量 (computePrimitivesKernel) 
2. 计算数值通量 (computeFluxesKernel)
	MUSCL重构 → 界面左右状态
	HLLC/HLL黎曼求解 → 界面通量
	计算内能通量
3. 更新守恒变量 (updateKernel) 
	通量差分
	欧拉前进
	双能量同步
	物理量限制（正性保持）
4. 交换缓冲区
5. 应用边界条件（applyBoundaryConditionsKernel）
	入流边界（固定来流条件）
	出流边界（零梯度外推）
	上下边界（非反射边界）
	Ghost Cell边界（滑移/无滑移混合）
6. 更新时间 t += dt
```

### 5.2 有粘性Navier-Stokes方程

```
1. 扩散半步 dt/2
	1a. 计算原始变量 (computePrimitivesKernel)
    1b. 计算粘性系数场 (computeViscosityKernel)
        使用Sutherland公式
    1c. 计算应力张量 (computeStressTensorKernel)
    1d. 计算热通量 (computeHeatFluxKernel)
        使用Fourier定律
    1e. 扩散积分 (diffusionStepKernel, dt/2)
        更新的粘性贡献 
2. 对流全步 dt
    2a. 计算原始变量 (computePrimitivesKernel)
    2b. 计算对流通量 (computeFluxesKernel)
    	MUSCL重构 → 界面左右状态
        HLLC/HLL黎曼求解 → 界面通量
        计算内能通量
    2c. 更新守恒变量 (updateKernel)
    	通量差分
        欧拉前进
        双能量同步
        物理量限制
    2d. 交换缓冲区
3. 扩散半步 dt/2
	3a. 计算原始变量 (computePrimitivesKernel)
    3b. 计算粘性系数场 (computeViscosityKernel)
        使用Sutherland公式
    3c. 计算应力张量 (computeStressTensorKernel)
    3d. 计算热通量 (computeHeatFluxKernel)
        使用Fourier定律
    3e. 扩散积分 (diffusionStepKernel, dt/2)
        更新的粘性贡献
4. 交换缓冲区
5. 应用边界条件（applyBoundaryConditionsKernel）
	入流边界（固定来流条件）
	出流边界（零梯度外推）
	上下边界（非反射边界）
	Ghost Cell边界（滑移/无滑移混合）
6. 更新时间 t += dt
```

## 6. 代码中物理量表

### 6.1 守恒物理量

**守恒变量（Conservative Variables）**：直接参与守恒方程的变量，由显存持久化存储。

以下的密度均为相对体积而言的密度。

| 代码变量名 | 数学符号 | 含义详解 (位置、方向、依赖关系)                              | 来源 (生成者) | 用途 (消费者) |
| ---------- | -------- | ------------------------------------------------------------ | ------------- | ------------- |
| `rho`      | $\rho$   | **【位置】中心** <br/> **【含义】** 方格内气体密度。 <br/> **【依赖】** 由显存存储，作为整个求解器维护的对象。 |               |               |
| `rho_u`    | $\rho u$ | **【位置】中心** <br/> **【含义】** x轴方向动量密度。 <br/> **【依赖】** 由显存存储，作为整个求解器维护的对象。 |               |               |
| `rho_v`    | $\rho v$ | **【位置】中心** <br/> **【含义】** y轴方向动量密度。 <br/> **【依赖】** 由显存存储，作为整个求解器维护的对象。 |               |               |
| `E`        | $E$      | **【位置】中心** <br/> **【含义】** 能量密度。 <br/> **【依赖】** 由显存存储，作为整个求解器维护的对象。 |               |               |

### 6.2 中间物理量

| 结构       | 含义                   | 例子                                                         |
| :--------- | :--------------------- | :----------------------------------------------------------- |
| **前缀**   | 变量的类型             | `flux_` (通量), `d_` (设备端数组), `dFx_` (通量的空间导数/变化率) |
| **物理量** | 这个变量里装着什么成分 | `rho` (质量), `rho_u` (x动量), `rho_v` (y动量), `E` (能量)   |
| **后缀**   | 这个变量归哪个方向管   | `_x` (管左右进出), `_y` (管上下进出), 没后缀 (表示标量或中心量) |


| 代码变量名                            | 数学符号                        | 含义详解 (位置、方向、依赖关系)                              | 来源 (生成者)                             | 用途 (消费者)                                                |
| :------------------------------------ | :------------------------------ | :----------------------------------------------------------- | :---------------------------------------- | :----------------------------------------------------------- |
| **1. 原始变量 (Primitives)**          |                                 | 相比于守恒变量更直观，但不适合维护。                         |                                           |                                                              |
| `d_u`, `d_v`                          | $u, v$                          | **【位置】中心** <br> **【含义】** 气流速度矢量。 <br> **【依赖】** 仅依赖当前格子的 $\rho, \rho u, \rho v$。 | `computePrimitivesKernel`                 | 1. `computeViscosity` <br> 2. `computeStressTensor` <br> 3. `computeFluxes` (重构用) |
| `d_p`                                 | $p$                             | **【位置】中心** <br> **【含义】** 热力学压强（各向同性，即向各个方向推力一样）。 <br> **【依赖】** 当前格子的 $E$ 和动能。 | `computePrimitivesKernel`                 | 1. `computeFluxes` (黎曼求解) <br> 2. `applyBoundary`        |
| `d_T`                                 | $T$                             | **【位置】中心** <br> **【含义】** 温度。 <br> **【依赖】** 状态方程 $P=\rho R T$。 | `computePrimitivesKernel`                 | 1. `computeViscosity` <br> 2. `computeHeatFlux`              |
| **2. 物性参数 (Navier-Stokes)**       |                                 |                                                              |                                           |                                                              |
| `d_mu`                                | $\mu$                           | **【位置】中心** <br> **【含义】** 动力粘度（流体有多稠）。 <br> **【依赖】** 当前格子的 $T$ (Sutherland公式)。 | `computeViscosityKernel`                  | `computeStressTensor`                                        |
| `d_k`                                 | $k$                             | **【位置】中心** <br> **【含义】** 热导率（传热有多快）。 <br> **【依赖】** 当前格子的 $\mu$。 | `computeViscosityKernel`                  | `computeHeatFlux`                                            |
| **3. 梯度项 (Navier-Stokes)**         |                                 |                                                              |                                           |                                                              |
| `tau_xx`, `tau_yy`                    | $\tau_{xx}, \tau_{yy}$          | **【位置】中心** <br> **【含义】** 正应力（拉伸/压缩）。因为速度场不均匀导致格子被拉长或压扁的内部摩擦力。 <br> **【依赖】** **上下左右邻居**的速度 (计算 $\partial u/\partial x$ 等)。 | `computeStressTensorKernel`               | `diffusionStepKernel`                                        |
| `tau_xy`                              | $\tau_{xy}$                     | **【位置】中心** <br> **【含义】** **切应力（剪切）**。最关键的粘性项。代表x动量在y方向传递的摩擦力。 <br> **【依赖】** **上下左右邻居**的速度。 | `computeStressTensorKernel`               | `diffusionStepKernel`                                        |
| `qx`, `qy`                            | $q_x, q_y$                      | **【位置】中心** <br> **【含义】** 热通量**矢量**。 <br> - `qx`: 热量向右流动的速度。 <br> - `qy`: 热量向上流动的速度。 <br> **【依赖】** **邻居**的温度梯度 $\nabla T$。 | `computeHeatFluxKernel`                   | `diffusionStepKernel`                                        |
| **4. 重构状态 (Flux Prep)**           |                                 | *注：这些通常是核函数内的临时变量，不持久存储*               |                                           |                                                              |
| `rhoL`, `uL`, `pL`                    | $U_L$                           | **【位置】右界面 ($i+1/2$) 的左侧** <br> **【含义】** 从格子 $i$ 内部推算到其右墙的状态值。 <br> **【依赖】** 格子 $i-1, i, i+1$ (MUSCL斜率)。 | `computeFluxesKernel` (内部)              | 黎曼求解器 (HLLC)                                            |
| `rhoR`, `uR`, `pR`                    | $U_R$                           | **【位置】右界面 ($i+1/2$) 的右侧** <br> **【含义】** 从格子 $i+1$ 内部反推回其左墙的状态值。 <br> **【依赖】** 格子 $i, i+1, i+2$。 | `computeFluxesKernel` (内部)              | 黎曼求解器 (HLLC)                                            |
| **5. 数值通量 (Numerical Fluxes)**    |                                 | **这是最核心的中间量**                                       |                                           |                                                              |
| `d_flux_..._x` <br> (如 `flux_rho_x`) | $\mathbf{F}_{i+1/2}$            | **【位置】右界面 ($i+1/2$)** <br> **【方向】** 垂直于界面向右。 <br> **【含义】** 单位时间**穿过这道墙**的物理量。 <br> - `flux_rho_x`: 穿墙的质量。 <br> - `flux_rho_u_x`: 穿墙的x动量(主要) + 墙上的压力。 <br> - `flux_rho_v_x`: 穿墙的y动量(被横风带走的侧向动量)。 <br> **【依赖】** 左侧 $i$ 和右侧 $i+1$ 的重构状态。 | `computeFluxesKernel` (`flux_rho_x[idx]`) | `updateKernel`                                               |
| `d_flux_..._y` <br> (如 `flux_rho_y`) | $\mathbf{G}_{j+1/2}$            | **【位置】上界面 ($j+1/2$)** <br> **【方向】** 垂直于界面向上。 <br> **【含义】** 单位时间**穿过天花板**的物理量。 <br> - `flux_rho_y`: 穿过天花板的质量。 <br> - `flux_rho_u_y`: 穿过天花板的x动量(被上升气流带走的横向动量)。 <br> **【依赖】** 下方 $j$ 和上方 $j+1$ 的重构状态。 | `computeFluxesKernel` (`flux_rho_y[idx]`) | `updateKernel`                                               |
| **6. 散度/残差 (Update Terms)**       |                                 | *注：这是 updateKernel 内计算的临时量*                       |                                           |                                                              |
| `dFx`                                 | $\frac{\partial F}{\partial x}$ | **【位置】中心** <br> **【含义】** X方向净流出量。 <br> **【算法】** (右界面通量 - 左界面通量) / dx。 <br> **【注意】** 左界面通量实际上就是 `flux_x[i-1]`。 | `updateKernel` (内部)                     | 更新守恒变量                                                 |
| `dFy`                                 | $\frac{\partial F}{\partial y}$ | **【位置】中心** <br> **【含义】** Y方向净流出量。 <br> **【算法】** (上界面通量 - 下界面通量) / dy。 <br> **【注意】** 下界面通量实际上就是 `flux_y[j-1]`。 |                                           |                                                              |

## 7. 补充：关于优化

[知乎-有限体积法](https://zhuanlan.zhihu.com/p/331771977)

### 7.1 双能量方法

气体速度非常快的时候，动能占总能量比例很高，如果只记录总能量，那么为了获得用于计算温度的内能值，算法需要用一个非常大的总能量`float`减去一个非常大的动能`float`，会导致数值不稳定。

气体压强非常低的时候，理想气体假设逐渐失效，气体表现得像是非常快速运动，但是相撞不频繁的粒子云。这个时候算法会用一个非常小的总能量`float`减去一个非常小的动能`float`，浮点数运算误差会导致尾流区域温度被估计到极高（引入前程序出现过的最高值为15000K，这是不可能的）。

因此需要额外维护一个气体状态量（网格内气体内能密度`d_rho_e_` ）

这个状态量的更新依赖于以下方程：
$$
\frac{\partial{(\rho e)}}{\partial t}+\nabla\cdot(\rho e\bold{u})=-p(\nabla\cdot\bold{u})
$$
可以理解为：
在每个无穷小的时间段内：

- 每个单元格都有一个内能密度的变化量（第一项）
- 由于气体流动（流入或流出），会有一个对流项（第二项），描述被气体速度散度所带走的内能密度
- 由于气体可压缩，速度散度也代表了气体正在膨胀还是收缩，根据理想气体状态方程，这会产生内能变化（右侧项）
- 第一项就是通过第二项和第三项计算出来的。

由于这个方程没有考虑摩擦生热（或任何动能转化为内能的机制），它在本场景下并不绝对的物理正确，存在误差，但是当气体非常稀薄或者速度非常快的时候，它比基本算法（总能量）更合理，不会出现极端高温。

此方法的实现表现为在`updateKernel()`函数中的以下几行

```cpp
// 1. 计算速度散度 div(v)
float div_v = du_dx + dv_dy;
// 2. 源项: d(rho*e)/dt = -p * div(v)
float source_rho_e = -p_c * div_v;

// balabala

// 3. 内能方程更新：旧值 - 通量散度 + 源项
float new_rho_e = rho_e[idx] - dt * (dFx_rho_e + dFy_rho_e) + dt * source_rho_e;
```

